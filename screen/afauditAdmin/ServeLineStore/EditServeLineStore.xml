<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.0.xsd">

    <parameter name="serveLineStoreId"/>

    <transition name="updateServeLineStore">
        <parameter name="action"/>
        <actions>
            <if condition="action == '0' &amp;&amp; (!checklistStatus || !serveLineId || !storeId)">
                <message error="true">Fields of Checklist Status, Serve Line Id, Store Id are required</message><return/></if>
            <if condition="serveLineStoreId">
                <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
                <if condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                <else>
                    <if condition="serveLineStore.checklistStatus == 60">
                        <message error="true">Fields of Checklist status has been Finished!</message><return/></if>
                </else></if>

                <if condition="action == '20' || action == '40' || action == '50' || action == '60' || action == '70'">
                    <set field="checklistStatus" from="action"/>
                    <set field="auditorId" from="serveLineStore.auditorId"/>
                    <set field="auditDate" from="serveLineStore.auditDate"/>
                    <set field="reviewerId" from="serveLineStore.reviewerId"/>
                    <set field="reviewDate" from="serveLineStore.reviewDate"/>
                    <set field="kaId" from="serveLineStore.kaId"/>
                    <set field="finishDate" from="serveLineStore.finishDate"/>
                    <set field="planEnd" from="serveLineStore.planEnd"/>
                    <set field="auditEnd" from="serveLineStore.auditEnd"/>
                    <set field="reviewEnd" from="serveLineStore.reviewEnd"/>
                    <set field="finishEnd" from="serveLineStore.finishEnd"/>
                </if>

                <if condition="checklistStatus != '10' &amp;&amp; (!auditorId || !auditDate || !reviewerId || !kaId)">
                    <message error="true">Fields of Auditor Id, Audit Date, Reviewer Id, KA Id are required</message><return/></if>
                <if condition="checklistStatus == '20'">
                    <if condition="!planEnd"><set field="planEnd" from="ec.user.nowTimestamp"/></if></if>
                <if condition="checklistStatus == '40'">
                    <if condition="ec.user.isInGroup('afaudit_ADMIN') || ec.user.isInGroup('ADMIN')">
                        <else-if condition="auditorId == ec.user.userId"><set field="auditDate" from="ec.user.nowTimestamp"/></else-if>
                        <else-if condition="auditorId != ec.user.userId &amp;&amp; reviewerId != ec.user.userId"><message error="true">This audit operation is not planned to you!</message><return/></else-if>
                    </if>
                    <if condition="!auditDate"><set field="auditDate" from="ec.user.nowTimestamp"/></if>
                    <if condition="!auditEnd"><set field="auditEnd" from="ec.user.nowTimestamp"/></if></if>
                <if condition="checklistStatus == '50'">
                    <if condition="ec.user.isInGroup('afaudit_ADMIN') || ec.user.isInGroup('ADMIN')">
                    <else-if condition="reviewerId != ec.user.userId &amp;&amp; kaId != ec.user.userId"><message error="true">This review operation is not planned to you!</message><return/></else-if></if>
                    <if condition="!reviewDate"><set field="reviewDate" from="ec.user.nowTimestamp"/></if>
                    <if condition="!reviewEnd"><set field="reviewEnd" from="ec.user.nowTimestamp"/></if>
                    <!--<if condition="reviewerId == ec.user.userId">-->
                        <!--<script>-->
                            <!--def flag = true-->
                            <!--if(auditDate instanceof String &amp;&amp; reviewDate instanceof String){-->
                                <!--String tmpAuditDate = serveLineStore.auditDate-->
                                <!--if (tmpAuditDate > reviewDate){flag = false}-->
                            <!--}else if(auditDate instanceof Date &amp;&amp; reviewDate instanceof Date){-->
                                <!--if(auditDate > reviewDate){flag = false}-->
                            <!--}-->
                        <!--</script>-->
                        <!--<if condition="flag == false"><message>Review date cannot be earlier than audit date!</message><set field="reviewDate" from="serveLineStore.auditDate"/></if>-->
                    <!--</if>-->
                </if>
                <if condition="checklistStatus == '60'">
                    <if condition="ec.user.isInGroup('afaudit_ADMIN') || ec.user.isInGroup('ADMIN')">
                    <else-if condition="kaId != ec.user.userId"><message error="true">This finish operation is not planned to you!</message><return/></else-if></if>
                    <if condition="!finishDate"><set field="finishDate" from="ec.user.nowTimestamp"/></if>
                    <if condition="!finishEnd"><set field="finishEnd" from="ec.user.nowTimestamp"/></if></if>

                <if condition="action == '0'">
                    <set field="map" from="context"/><script>map.remove("serveLineId"); map.remove("storeId")</script>
                    <service-call name="update#afaudit.ServeLineStore" in-map="map"/>
                <else-if condition="action == '20' || action == '40' || action == '50' || action == '60'">
                    <service-call name="update#afaudit.ServeLineStore" in-map="[serveLineStoreId:serveLineStoreId, checklistStatus:action, auditDate:auditDate, reviewDate:reviewDate, finishDate:finishDate, planEnd:planEnd, auditEnd:auditEnd, reviewEnd:reviewEnd, finishEnd:finishEnd]"/></else-if>
                <else-if condition="action == '70'">
                    <if condition="serveLineStore.checklistStatus == 40"><set field="action" value="35"/>
                    <else-if condition="serveLineStore.checklistStatus == 50"><set field="action" value="35"/></else-if></if>

                    <service-call name="update#afaudit.ServeLineStore" in-map="[serveLineStoreId:serveLineStoreId, checklistStatus:action]"/></else-if>
                </if>
            <else>
                <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore">
                    <field-map field-name="serveLineId"/><field-map field-name="storeId"/><field-map field-name="auditDate"/>
                </entity-find-one>
                <if condition="serveLineStore">
                    <message error="true">Fields of Serve Line Id, Store Id, Audit Date are existed</message><return/></if>

                <service-call name="create#afaudit.ServeLineStore" in-map="context" out-map="context"/></else>
            </if>
        </actions>

        <default-response url="."/>
    </transition>
    <transition name="fillChecklist">
        <actions>
            <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
            <if condition="serveLineStore.checklistStatus == 60">
                <message error="true">Fields of Checklist status has been Finished!</message><return/></if>
            <!--delete existed Checklist report-->
            <entity-find-one entity-name="afaudit.Attachment" value-field="attachment">
                <field-map field-name="attachmentType" value="ServeLineStore-Checklist"/>
                <field-map field-name="dataId" from="serveLineStoreId"/>
            </entity-find-one>
            <if condition="attachment">
                <message error="true">Checklist has been exist! It must be delete before create again!</message><return/></if>
            <!--find data list-->
            <entity-find-one entity-name="afaudit.ViewAuditedCheckItem" value-field="viewAuditedCheckItem">
                <field-map field-name="serveLineStoreId"/>
            </entity-find-one>
            <if condition="!viewAuditedCheckItem">
                <message error="true">Checklist has no data!</message><return/>
            </if>
            <entity-find-one entity-name="afaudit.ViewServeLineStore" value-field="viewServeLineStore">
                <field-map field-name="serveLineStoreId"/>
            </entity-find-one>
            <!--find Checklist template-->
            <entity-find-one entity-name="afaudit.Attachment" value-field="attachment">
                <field-map field-name="attachmentType" value="Checklist-Checklist"/>
                <field-map field-name="dataId" from="viewServeLineStore.checklistId"/>
            </entity-find-one>
            <if condition="!attachment">
                <message error="true">Checklist template has not been upload!</message><return/>
            </if>
            <!--update Checklist template and output-->
            <entity-find-one entity-name="afaudit.Reference" value-field="reference">
                <field-map field-name="referenceId" from="viewServeLineStore.customerRefId"/></entity-find-one>
            <if condition="reference.attribute=='RTM'">
                <!--find all history data in this serve-->
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveId" from="viewServeLineStore.serveId"/>
                    <econdition field-name="storeId" from="viewServeLineStore.storeId"/>
                    <econdition field-name="auditDate" operator="less-equals" from="viewServeLineStore.auditDate"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <service-call name="afaudit.RTMServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment]"/>
            <else-if condition="reference.attribute=='CRV'">
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveLineStoreId" from="serveLineStore.serveLineStoreId"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <service-call name="afaudit.CRVServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment]"/>
            </else-if>
            <else-if condition="reference.attribute=='ELE'">
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveLineStoreId" from="serveLineStore.serveLineStoreId"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <service-call name="afaudit.ELEServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment]"/>
            </else-if>
            <else-if condition="reference.attribute=='Disney'">
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveLineStoreId" from="serveLineStore.serveLineStoreId"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <service-call name="afaudit.DisneyServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment]"/>
            </else-if>
            <else-if condition="reference.attribute=='Metro'">
                <!--find all history data in this serve-->
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveId" from="viewServeLineStore.serveId"/>
                    <econdition field-name="storeId" from="viewServeLineStore.storeId"/>
                    <econdition field-name="auditDate" operator="less-equals" from="viewServeLineStore.auditDate"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <entity-find entity-name="afaudit.ViewRoundInServe" list="viewRoundInServeList">
                    <econdition field-name="serveId" from="viewServeLineStore.serveId"/>
                    <econditions combine="or">
                        <econdition field-name="storeId" from="viewServeLineStore.storeId"/>
                        <econdition field-name="storeId" or-null="true"/>
                    </econditions>
                    <econdition field-name="fromDate" operator="less-equals" from="viewServeLineStore.fromDate"/>
                    <order-by field-name="fromDate"/>
                    <order-by field-name="auditDate"/>
                </entity-find>
                <service-call name="afaudit.MetroServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment, viewRoundInServeList:viewRoundInServeList]"/>
            </else-if>
            <else-if condition="reference.attribute=='Lawson'">
                <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                    <econdition field-name="serveLineStoreId" from="serveLineStore.serveLineStoreId"/>
                    <order-by field-name="checkGroup,itemNo,auditDate,serveLineStoreCheckItemId"/>
                </entity-find>

                <service-call name="afaudit.LawsonServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, viewAuditedCheckItemList:viewAuditedCheckItemList, attachment:attachment]"/>
            </else-if>
            <else-if condition="reference.attribute=='FDA'">
                <service-call name="afaudit.FDAServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
                viewServeLineStore:viewServeLineStore, attachment:attachment]"/>
            </else-if>
            <else-if condition="reference.attribute=='BreakTalk'">
                <service-call name="afaudit.BreakTalkServices.fill#Checklist" in-map="[serveLineStoreId:serveLineStoreId, viewAuditedCheckItem:viewAuditedCheckItem,
            viewServeLineStore:viewServeLineStore, attachment:attachment]"/>
            </else-if></if>
        </actions>
        <default-response url="."/>
    </transition>
    <transition name="fillSummary">
        <actions>
            <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
            <if condition="serveLineStore.checklistStatus == 60">
                <message error="true">Fields of Checklist status has been Finished!</message><return/></if>
            <!--delete existed Summary report-->
            <entity-find-one entity-name="afaudit.Attachment" value-field="attachment">
                <field-map field-name="attachmentType" value="ServeLineStore-Summary"/>
                <field-map field-name="dataId" from="serveLineStoreId"/>
            </entity-find-one>
            <if condition="attachment">
                <message error="true">Summary has been exist! It must be delete before create again!</message><return/></if>
            <!--find data list-->
            <entity-find-one entity-name="afaudit.ViewAuditedCheckItem" value-field="viewAuditedCheckItem">
                <field-map field-name="serveLineStoreId"/>
            </entity-find-one>
            <if condition="!viewAuditedCheckItem">
                <message error="true">Checklist has no data!</message><return/>
            </if>
            <entity-find-one entity-name="afaudit.ViewServeLineStore" value-field="viewServeLineStore">
                <field-map field-name="serveLineStoreId"/>
            </entity-find-one>
            <entity-find entity-name="afaudit.ViewAuditedCheckItem" list="viewAuditedCheckItemList">
                <econdition field-name="serveLineStoreId" from="serveLineStoreId"/>
                <econdition field-name="fromDate" operator="less-equals" from="viewAuditedCheckItem.fromDate"/>
                <order-by field-name="checkGroup,itemNo,fromDate"/>
            </entity-find>
            <entity-find entity-name="afaudit.Attachment" list="attachmentList">
                <econdition field-name="attachmentType" value="ServeLineStore-AuditConfirm"/>
                <econdition field-name="dataId" from="serveLineStoreId"/>
            </entity-find>
            <entity-find entity-name="afaudit.ViewCheckItemAttachment" list="checkItemAttachmentList">
                <econdition field-name="serveLineStoreId" from="serveLineStoreId"/>
                <order-by field-name="checkGroup,itemNo,serveLineStoreCheckItemId"/>
            </entity-find>
            <!--update Summary template and output-->
            <service-call name="afaudit.afauditServices.fill#Summary" in-map="[serveLineStoreId:serveLineStoreId, viewServeLineStore:viewServeLineStore,
                viewAuditedCheckItemList:viewAuditedCheckItemList, attachmentList:attachmentList, checkItemAttachmentList:checkItemAttachmentList]"/>
        </actions>
        <default-response url="."/>
    </transition>
    <transition name="getServeLineId">
        <service-call name="afaudit.afauditServices.get#ServeLineIds" in-map="[customerId : customerId]"/>

        <default-response type="none"/>
    </transition>
    <transition name="getStoreId">
        <service-call name="afaudit.afauditServices.get#StoreIds" in-map="[customerId : customerId]"/>

        <default-response type="none"/>
    </transition>
    <transition name="uploadAttachment">
        <actions>
            <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
            <if condition="serveLineStore.checklistStatus == 60">
                <message error="true">Fields of Checklist status has been Finished!</message><return/></if>
            <!--delete existed Attachment-->
            <entity-find-one entity-name="afaudit.Attachment" value-field="attachment">
                <field-map field-name="attachmentType" from="attachmentType"/>
                <field-map field-name="dataId" from="serveLineStoreId"/>
            </entity-find-one>
            <if condition="attachment">
                <message error="true">${attachmentType} has been exist! It must be delete before upload!</message><return/></if>

            <script><![CDATA[
                import org.moqui.resource.ResourceReference

                org.moqui.context.ExecutionContext ec = context.ec
                org.apache.commons.fileupload.FileItem contentFile = context.attachmentFile

                if(contentFile.getSize() > (5 * 1024 * 1024)){
                    ec.message.addError("File size limit exceeded 5 M!");
                    return;
                }

                String fileName = contentFile.getName()
                if(fileName.length() != 0){
                    String attachmentLocation = "dbresource://afauditApp/attachment/${attachmentType}/${serveLineStoreId}/${fileName}"
                    String attachmentUrl = ec.web.getWebappRootUrl(true, null) + "/apps/afauditApp/rest/attachment/${attachmentType}/${serveLineStoreId}/${fileName}"

                    ResourceReference newRr = ec.resource.getLocationReference(attachmentLocation)
                    InputStream fileStream = contentFile.getInputStream()
                    newRr.putStream(fileStream)
                    fileStream.close()

                    ec.service.sync().name("create", "afaudit.Attachment").parameters([attachmentType: attachmentType, dataId: serveLineStoreId, attachmentLocation: attachmentLocation, attachmentUrl: attachmentUrl]).call()
                }
            ]]></script>
        </actions>
        <default-response url="."/>
    </transition>
    <transition name="downloadAttachment">
        <actions>
            <script>ec.web.sendResourceResponse(attachmentLocation)</script>
        </actions>
        <default-response type="none"/>
    </transition>
    <transition name="deleteAttachment">
        <actions>
            <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
            <if condition="serveLineStore.checklistStatus == 60">
                <message error="true">Fields of Checklist status has been Finished!</message><return/></if>

            <entity-find-one entity-name="afaudit.Attachment" value-field="attachment">
                <field-map field-name="attachmentId" from="attachmentId"/>
            </entity-find-one>

            <script><![CDATA[
                import org.moqui.resource.ResourceReference
                org.moqui.context.ExecutionContext ec = context.ec
                ResourceReference newRr = ec.resource.getLocationReference("${attachment.attachmentLocation}")
                newRr.delete()
            ]]></script>

            <service-call name="delete#afaudit.Attachment" in-map="[attachmentId:attachmentId]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <actions>
        <if condition="serveLineStoreId">
            <if condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
            <else>
                <entity-find-count entity-name="afaudit.ServeLineStore" count-field="count">
                    <econdition field-name="serveLineStoreId" from="serveLineStoreId"/>
                    <econditions combine="or">
                        <econditions combine="and">
                            <econdition field-name="auditorId" from="ec.user.userId"/>
                            <econdition field-name="checklistStatus" operator="in" from="[10,20,30,35,40]"/>
                        </econditions>
                        <econditions combine="and">
                            <econdition field-name="reviewerId" from="ec.user.userId"/>
                            <econdition field-name="checklistStatus" operator="in" from="[30,35,40,50]"/>
                        </econditions>
                        <econditions combine="and">
                            <econdition field-name="kaId" from="ec.user.userId"/>
                            <econdition field-name="checklistStatus" operator="in" from="[10,20,30,35,40,50,60]"/>
                        </econditions>
                    </econditions>
                </entity-find-count>

                <if condition="count==0">
                    <message error="true">No permission</message><return/></if>
            </else></if>

            <entity-find-one entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/>
            <!--ServeLineStore attachment-->
            <entity-find entity-name="afaudit.Attachment" list="attachmentList">
                <econdition field-name="attachmentType" operator="in"
                            value="ServeLineStore-Checklist,ServeLineStore-AuditConfirm,ServeLineStore-Summary"/>
                <econdition field-name="dataId" from="serveLineStoreId"/>
            </entity-find>
            <!--ViewCheckItemAttachment attachment-->
            <entity-find entity-name="afaudit.ViewCheckItemAttachment" list="checkItemAttachmentList">
                <econdition field-name="serveLineStoreId" from="serveLineStoreId"/>
            </entity-find>
            <!--customerId-->
            <entity-find-one entity-name="afaudit.ViewServeLineStore" value-field="viewServeLineStore">
                <field-map field-name="serveLineStoreId" from="serveLineStoreId"/>
            </entity-find-one>
            <set field="customerId" from="viewServeLineStore.customerId"/>
        <else>
            <entity-make-value entity-name="afaudit.ServeLineStore" value-field="serveLineStore"/></else></if>
    </actions>

    <widgets>
        <container style="project-afaudit">
            <container>
                <link url="../FindServeLineStore" text="Back" icon="glyphicon glyphicon-step-backward" parameter-map="[serveLineStoreId:serveLineStoreId]"/>
                <section name="SectionServeLineStoreId" condition="(serveLineStore.checklistStatus == 30)||(serveLineStore.checklistStatus == 35)||(serveLineStore.checklistStatus == 40)||(serveLineStore.checklistStatus == 50)">
                    <widgets>
                        <container-dialog id="UploadAttachmentDialog" button-text="Upload">
                            <form-single name="UploadAttachment" transition="uploadAttachment">
                                <field name="serveLineStoreId"><default-field><hidden/></default-field></field>
                                <field name="attachmentType"><default-field title="Type">
                                    <drop-down>
                                        <!--<option key="ServeLineStore-AuditConfirm" text="ServeLineStore-AuditConfirm"/>-->
                                        <option key="ServeLineStore-Checklist" text="ServeLineStore-Checklist"/>
                                        <option key="ServeLineStore-Summary" text="ServeLineStore-Summary"/>
                                    </drop-down><label text="*" style="label-red"/></default-field></field>
                                <field name="attachmentFile"><default-field title="File"><file/></default-field></field>
                                <field name="submitButton"><default-field title="OK"><submit icon="glyphicon glyphicon-ok"/></default-field></field>
                            </form-single>
                            <section name="Template"><widgets>
                                <label text=" Template file link : "/><link url="../templateAuditConfirm.doc" text="templateAuditConfirm.doc" target-window="_blank" link-type="anchor"/>
                            </widgets></section>
                        </container-dialog>
                    </widgets>
                </section>
                <link url="fillChecklist" text="Checklist" icon="glyphicon glyphicon-list-alt" condition="(serveLineStore.checklistStatus == 30)||(serveLineStore.checklistStatus == 35)||(serveLineStore.checklistStatus == 40)||(serveLineStore.checklistStatus == 50)"/>
                <link url="fillSummary" text="Summary" icon="glyphicon glyphicon-folder-close" condition="(serveLineStore.checklistStatus == 30)||(serveLineStore.checklistStatus == 35)||(serveLineStore.checklistStatus == 40)||(serveLineStore.checklistStatus == 50)"/>
                <!--<link url="updateServeLineStore" text="Plan" icon="glyphicon glyphicon-list-alt" condition="serveLineStore.checklistStatus == 10 &amp;&amp; (ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN'))" parameter-map="[action:20]"/>-->
                <link url="updateServeLineStore" text="Audit" icon="glyphicon glyphicon-paperclip" condition="(serveLineStore.checklistStatus == 30 || serveLineStore.checklistStatus == 35) &amp;&amp; ec.user.isInGroup('afaudit_AUDITOR')"
                      parameter-map="[action:40]"/>
                <link url="updateServeLineStore" text="Review" icon="glyphicon glyphicon-pushpin" condition="serveLineStore.checklistStatus == 40 &amp;&amp; (ec.user.isInGroup('afaudit_REVIEWER') || ec.user.isInGroup('afaudit_KA'))"
                      parameter-map="[action:50]"/>
                <link url="updateServeLineStore" text="Finish" icon="glyphicon glyphicon-ok-circle" condition="serveLineStore.checklistStatus == 50 &amp;&amp; ec.user.isInGroup('afaudit_KA')"
                      parameter-map="[action:60]" confirmation="${'Note: Data cannot be modified after Finished! \n\nReally finish?'}"/>
                <link url="updateServeLineStore" text="Reject" icon="glyphicon glyphicon-remove-circle" condition="(serveLineStore.checklistStatus == 40 || serveLineStore.checklistStatus == 50)&amp;&amp; (ec.user.isInGroup('afaudit_REVIEWER') || ec.user.isInGroup('afaudit_KA'))"
                      parameter-map="[action:70]" confirmation="${'Really reject?'}"/>
            </container>

            <container>
                <form-single name="EditServeLineStore" transition="updateServeLineStore" map="serveLineStore">
                    <field name="action"><default-field><hidden default-value="0"/></default-field></field>
                    <field name="planEnd"><default-field><hidden/></default-field></field>
                    <field name="auditEnd"><default-field><hidden/></default-field></field>
                    <field name="reviewEnd"><default-field><hidden/></default-field></field>
                    <field name="finishEnd"><default-field><hidden/></default-field></field>
                    <field name="serveLineStoreId"><default-field title="ID"><display/></default-field></field>
                    <field name="customerId" from="customerId">
                        <conditional-field condition="serveLineStoreId">
                            <display-entity entity-name="afaudit.Customer" key-field-name="customerId" text="CustomerIdTemplate"/></conditional-field>
                        <conditional-field condition="ec.user.isInGroup('afaudit_KA')">
                            <drop-down allow-empty="true">
                                <entity-options text="CustomerIdTemplate">
                                    <entity-find entity-name="afaudit.Customer">
                                        <econdition field-name="kaId" from="ec.user.userId"/></entity-find></entity-options>
                            </drop-down><label text="*" style="label-red"/></conditional-field>
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <drop-down allow-empty="true">
                                <entity-options text="CustomerIdTemplate">
                                    <entity-find entity-name="afaudit.Customer"/></entity-options>
                            </drop-down><label text="*" style="label-red"/></conditional-field>
                        <default-field>
                            <display/></default-field></field>
                    <field name="serveLineId">
                        <conditional-field condition="serveLineStoreId">
                            <display-entity entity-name="afaudit.ViewServeLine" text="ServeLineIdTemplate" key-field-name="serveLineId"/></conditional-field>
                        <default-field>
                            <drop-down>
                                <dynamic-options transition="getServeLineId" label-field="serveLineIdTemplate" value-field="serveLineId">
                                    <depends-on field="customerId"/>
                                </dynamic-options>
                            </drop-down><label text="*" style="label-red"/></default-field></field>
                    <field name="storeId">
                        <conditional-field condition="serveLineStoreId">
                            <display-entity entity-name="afaudit.Store" key-field-name="storeId" text="StoreIdTemplate"/></conditional-field>
                        <default-field>
                            <drop-down>
                                <dynamic-options transition="getStoreId" label-field="storeIdTemplate" value-field="storeId">
                                    <depends-on field="customerId"/>
                                </dynamic-options>
                            </drop-down><label text="*" style="label-red"/></default-field></field>
                    <field name="auditType"><default-field>
                        <drop-down allow-empty="false">
                            <option key="1" text="Normal [1]"/><option key="2" text="Morning [2]"/><option key="3" text="Night [3]"/><option
                                key="4" text="ReAudit [4]"/><option key="5" text="Festival [5]"/>
                        </drop-down></default-field></field>
                    <field name="auditDate">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <date-time type="date"/></conditional-field>
                        <default-field><display/></default-field></field>
                    <field name="auditorId">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <drop-down allow-empty="true">
                                <entity-options text="UsernameTemplate">
                                    <entity-find entity-name="afaudit.ViewUserAccount">
                                        <econdition field-name="userGroupId" value="afaudit_AUDITOR"/><order-by field-name="username"/></entity-find></entity-options>
                            </drop-down></conditional-field>
                        <default-field>
                            <display-entity entity-name="afaudit.ViewUserAccount" text="UsernameTemplate" key-field-name="userId"/></default-field></field>
                    <field name="reviewDate">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <date-time type="date"/></conditional-field>
                        <default-field><display/></default-field></field>
                    <field name="reviewerId">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <drop-down allow-empty="true">
                                <entity-options text="UsernameTemplate">
                                    <entity-find entity-name="afaudit.ViewUserAccount">
                                        <econdition field-name="userGroupId" value="afaudit_REVIEWER"/><order-by field-name="username"/></entity-find></entity-options>
                            </drop-down></conditional-field>
                        <default-field>
                            <display-entity entity-name="afaudit.ViewUserAccount" text="UsernameTemplate" key-field-name="userId"/></default-field></field>
                    <field name="finishDate">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <date-time type="date"/></conditional-field>
                        <default-field><display/></default-field></field>
                    <field name="kaId">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <drop-down allow-empty="true">
                                <entity-options text="UsernameTemplate">
                                    <entity-find entity-name="afaudit.ViewUserAccount">
                                        <econdition field-name="userGroupId" value="afaudit_KA"/><order-by field-name="username"/></entity-find></entity-options>
                            </drop-down></conditional-field>
                        <default-field>
                            <display-entity entity-name="afaudit.ViewUserAccount" text="UsernameTemplate" key-field-name="userId"/></default-field></field>
                    <field name="checklistStatus">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')">
                            <drop-down>
                                <option key="10" text="Created [10]"/><option key="20" text="Planned [20]"/><option key="30" text="Auditing [30]"/><option key="35" text="Auditing_Reject [35]"/><option
                                key="40" text="Audited [40]"/><option key="50" text="Reviewed [50]"/><option key="60" text="Finished [60]"/>
                            </drop-down><label text="*" style="label-red"/>
                        </conditional-field>
                        <default-field>
                            <display text="${checklistStatus==10?'Created':(checklistStatus==20?'Planned':checklistStatus==30?'Auditing':checklistStatus==35?'Auditing_Reject':checklistStatus==40?'Audited':checklistStatus==50?'Reviewed':checklistStatus==60?'Finished':'')} [${checklistStatus}]"/>
                        </default-field>
                    </field>
                    <field name="storeManager"><default-field><text-line size="50"/></default-field></field>
                    <field name="comment"><default-field><text-area cols="100"/></default-field></field>
                    <!--<field name="keyPoint"><default-field><text-area/></default-field></field>-->
                    <field name="remark"><default-field><text-area cols="100"/></default-field></field>
                    <field name="rejectRemark">
                        <conditional-field condition="ec.user.isInGroup('afaudit_ADMIN')||ec.user.isInGroup('ADMIN')||ec.user.isInGroup('afaudit_KA')||ec.user.isInGroup('afaudit_REVIEWER')">
                            <text-area cols="100"/></conditional-field>
                        <default-field><display/></default-field></field>
                    <field name="updateButton"><default-field>
                        <submit text="Update" icon="glyphicon glyphicon-floppy-disk"/></default-field></field>
                </form-single>
            </container>

            <section name="Attachments" condition="(serveLineStore.checklistStatus == 30)||(serveLineStore.checklistStatus == 35)||(serveLineStore.checklistStatus == 40)||(serveLineStore.checklistStatus == 50)||(serveLineStore.checklistStatus == 60)">
                <widgets>
                    <form-list name="ListAttachment" list="attachmentList">
                        <field name="attachmentId"><default-field title="ID">
                            <link text="${attachmentId}" url="downloadAttachment" icon="glyphicon glyphicon-save" parameter-map="[attachmentLocation:attachmentLocation]"/>
                        </default-field></field>
                        <field name="attachmentType"><default-field title="Type"><display/></default-field></field>
                        <field name="attachmentLocation"><default-field title="Location"><display/></default-field></field>
                        <field name="delete"  hide="serveLineStore.checklistStatus == 60"><default-field title="">
                            <link url="deleteAttachment" text="Delete" confirmation="${ec.l10n.localize('Really Delete?')}" icon="glyphicon glyphicon-remove" parameter-map="[attachmentId:attachmentId]"/></default-field>
                        </field>
                    </form-list>

                    <!--<form-list name="ListCheckItemAttachment" list="checkItemAttachmentList">-->
                        <!--<field name="attachmentId"><default-field title="ID">-->
                            <!--<link text="${attachmentId}" url="downloadAttachment" icon="glyphicon glyphicon-save" parameter-map="[attachmentLocation:attachmentLocation]"/>-->
                        <!--</default-field></field>-->
                        <!--<field name="checkGroup"><default-field><display/></default-field></field>-->
                        <!--<field name="checkType"><default-field><display/></default-field></field>-->
                        <!--<field name="itemNo"><default-field><display/></default-field></field>-->
                        <!--<field name="attachmentType"><default-field title="Type"><display/></default-field></field>-->
                        <!--<field name="attachmentLocation"><default-field title="Location"><display/></default-field></field>-->
                        <!--<field name="delete" hide="serveLineStore.checklistStatus == 60"><default-field>-->
                            <!--<link url="deleteAttachment" text="Delete" confirmation="${ec.l10n.localize('Really Delete?')}" icon="glyphicon glyphicon-remove" parameter-map="[attachmentId:attachmentId]"/></default-field>-->
                        <!--</field>-->
                    <!--</form-list>-->
                </widgets>
            </section>
        </container>

    </widgets>
</screen>
